---
description: 機能の計画ドキュメントを作成し、品質レビュー後にユーザー確認で停止
---

# 機能計画フェーズ (plan-feature)

**目的:** 計画ドキュメントの作成と品質レビューを行い、ユーザー確認で停止する

**引数パターン:**
- `/plan-feature 機能名` - PRDから該当機能を検索し、要件を抽出（見つからない場合は新規定義）
- `/plan-feature --from-idea ファイル名` - 指定したアイデアファイルから
- `/plan-feature --from-idea` - 最新のアイデアファイルから
- `/plan-feature --from-plan ファイル名` - 指定した計画ファイル（docs/plan/）から
- `/plan-feature --from-plan` - 最新の計画ファイルから
- `/plan-feature --new 機能名` - PRDを参照せず新規に要件定義

---

## ステップ1: 準備とコンテキスト設定

1. **引数の解析**
   - `--from-idea`オプションの有無を確認
   - `--from-plan`オプションの有無を確認
   - ファイル名が指定されていない場合は最新のファイルを使用

2. **計画ファイルからの読み込み（--from-plan使用時）**
   ```
   # ファイル名指定時
   Read('docs/plan/[指定されたファイル名].md')

   # ファイル名未指定時（最新を使用）
   Glob('docs/plan/*.md')
   → 最新のファイルを選択
   Read('docs/plan/[最新ファイル]')
   ```

   **計画ファイルの構造解析:**
   - `## 概要` → requirements.mdの概要セクション
   - `## 問題と修正方針` → requirements.mdの要件詳細
   - `## 修正対象ファイル` → design.mdの変更対象
   - `## 実装ステップ` → tasklist.mdのタスク一覧
   - `## 検証方法` → requirements.mdの受け入れ条件

3. **アイデアファイルからの読み込み（--from-idea使用時）**
   ```
   # ファイル名指定時
   Read('docs/ideas/[指定されたファイル名].md')

   # ファイル名未指定時（最新を使用）
   Glob('docs/ideas/*.md')
   → 最新のファイルを選択
   Read('docs/ideas/[最新ファイル]')
   ```

4. **コンテキストの確立**
   - 機能名: アイデアファイルのタイトルまたは引数から取得
   - 日付: `[現在の日付をYYYYMMDD形式で取得]`
   - ステアリングディレクトリパス: `.steering/[日付]-[機能名]/`

5. **ステアリングディレクトリの作成**
   ```
   Bash('mkdir -p .steering/[日付]-[機能名]/')
   ```

6. **3つの空ファイルを作成**
   - `[ステアリングディレクトリパス]/requirements.md`
   - `[ステアリングディレクトリパス]/design.md`
   - `[ステアリングディレクトリパス]/tasklist.md`

## ステップ1.5: PRDからの機能情報抽出（機能名指定時）

**条件**: `/plan-feature 機能名` の形式で実行された場合（`--from-idea` および `--new` なし）

1. **PRDの読み込み**
   ```
   Read('docs/core/product-requirements.md')
   ```

2. **機能名によるセクション検索**
   PRD内の「機能要件」セクションから、引数の機能名に一致または類似する機能を検索:
   - 完全一致: 「問題生成」→「問題生成（選択式）」
   - 部分一致: 「教材」→「教材アップロード・解析」
   - キーワード: 「弱点」→「弱点論点の優先出題」

3. **該当機能の情報抽出**
   見つかった機能セクションから以下を抽出:
   - ユーザーストーリー
   - 受け入れ条件（チェックリスト形式）
   - 検証方法
   - 優先度

4. **抽出結果の活用**
   - 抽出した受け入れ条件を `requirements.md` に転記
   - 検証方法を `tasklist.md` のテスト項目として活用

5. **該当機能が見つからない場合**
   ユーザーに以下を表示:
   ```
   PRD内に「[機能名]」に該当する機能が見つかりませんでした。

   利用可能な機能:
   - 教材アップロード・解析 (P0)
   - 問題生成（選択式） (P0)
   - 出題・採点・解説表示 (P0)
   - 問題品質検証 (P1)
   - 学習履歴の記録 (P1)
   - 弱点論点の優先出題 (P1)
   ...

   上記から選択するか、新規機能として定義しますか？
   ```

## ステップ2: プロジェクト理解

1. **CLAUDE.mdを読み、プロジェクトの全体像を把握する**
   - コマンド体系、開発フロー、アーキテクチャ概要を確認

2. **docs/core/のドキュメントを目的別に確認する**

   **必須（常に確認）:**
   ```
   Read('docs/core/product-requirements.md')
   ```
   - プロダクト要件定義、各機能のユーザーストーリー・受け入れ条件を理解
   - 優先度（P0/P1/P2）を確認し、依存関係を把握

   ```
   Read('docs/core/architecture.md')
   ```
   - 既存コンポーネントの責務と関係性を理解
   - 新機能が影響を与えるレイヤー（Collector/Processor/Publisher等）を特定

   ```
   Read('docs/core/development-guidelines.md')
   ```
   - コーディング規約（命名規則、型ヒント、docstring）
   - エラー処理・非同期処理パターン

   ```
   Read('docs/core/repository-structure.md')
   ```
   - 新規ファイルの配置場所を決定
   - 既存モジュールとの依存関係を把握

   **条件付き（必要に応じて確認）:**
   ```
   Read('docs/core/api-reference.md')  # 既存APIを拡張する場合
   Read('docs/core/diagrams.md')       # データフローを変更する場合
   ```

3. **確認結果の要約**
   以下を把握してからステップ3へ進む:
   - 新機能が属するレイヤー
   - 再利用可能な既存パターン
   - 遵守すべきコーディング規約
   - 新規ファイルの配置場所

## ステップ3: 既存パターンの調査

1. Grepツールを使用し、機能名に関連するキーワードでソースコード(`src/`)を検索する。
   ```bash
   Grep('[機能に関連するキーワード]', 'src/')
   ```

2. 検索結果を分析し、既存の実装パターン、命名規則、コンポーネントの利用方法を特定する。

## ステップ4: 計画ドキュメント生成

### --from-idea使用時の特別処理

1. **アイデアファイルの内容をrequirements.mdに転記**
   - アイデアファイルの「概要」「背景」「実装する機能」「受け入れ条件」「スコープ外」をrequirements.mdにマッピング
   - テンプレート（`.claude/skills/steering/templates/requirements.md`）の形式に整形

2. **design.mdの生成**

   **2.1 アイデアファイルから抽出:**
   - 「解決策」セクション → アーキテクチャ概要、コンポーネント設計の基盤
   - 「技術的考慮事項」セクション → エラーハンドリング、パフォーマンス考慮

   **2.2 docs/core/との整合性確認チェックリスト:**

   | 確認項目 | 参照ドキュメント | 確認内容 |
   |----------|------------------|----------|
   | レイヤー配置 | architecture.md | 新コンポーネントが正しいレイヤーに配置されているか |
   | 命名規則 | development-guidelines.md | クラス名・関数名が規約に従っているか |
   | 非同期パターン | development-guidelines.md | Semaphore、バッチ処理等のパターンを使用しているか |
   | エラー処理 | development-guidelines.md | リトライ・フォールバック戦略が定義されているか |
   | ファイル配置 | repository-structure.md | 新規ファイルが正しいディレクトリに配置されているか |

   **2.3 design.mdへの反映:**
   - テンプレート（`.claude/skills/steering/templates/design.md`）に従って生成
   - 整合性確認で特定したパターンをdesign.mdの各セクションに反映

3. **tasklist.mdの生成**
   - requirements.mdとdesign.mdに基づいてタスクを洗い出し
   - テンプレート（`.claude/skills/steering/templates/tasklist.md`）に従って生成

### PRDから機能情報を抽出した場合

ステップ1.5でPRDから該当機能が見つかった場合の処理:

1. **requirements.mdの生成**
   - PRDのユーザーストーリー → 概要セクション
   - PRDの受け入れ条件 → 受け入れ条件セクション（そのまま転記）
   - PRDの検証方法 → 検証方法セクション
   - テンプレート（`.claude/skills/steering/templates/requirements.md`）の形式に整形

2. **design.mdの生成**
   - PRDの検証方法を参考に技術設計を検討
   - architecture.md/development-guidelines.mdとの整合性を確認
   - テンプレート（`.claude/skills/steering/templates/design.md`）に従って生成

3. **tasklist.mdの生成**
   - PRDの受け入れ条件をタスク化
   - PRDの検証方法をテストタスク化
   - テンプレート（`.claude/skills/steering/templates/tasklist.md`）に従って生成

### 計画ファイルから生成する場合（--from-plan使用時）

1. **requirements.mdの生成**
   - 計画ファイルの「概要」→ 概要セクション
   - 計画ファイルの「問題と修正方針」→ 機能要件セクション
   - 計画ファイルの「検証方法」→ 受け入れ条件セクション
   - テンプレート（`.claude/skills/steering/templates/requirements.md`）の形式に整形

2. **design.mdの生成**
   - 計画ファイルの「修正対象ファイル」→ 変更対象セクション
   - 計画ファイルの「問題と修正方針」→ 実装方針セクション
   - テンプレート（`.claude/skills/steering/templates/design.md`）に従って生成

3. **tasklist.mdの生成**
   - 計画ファイルの「実装ステップ」→ タスク一覧（チェックボックス形式に変換）
   - テンプレート（`.claude/skills/steering/templates/tasklist.md`）に従って生成

### 従来モード（--from-ideaなし、--from-planなし、--new使用時）

1. `Skill('steering')`を**計画モード**で実行し、ステップ1で作成した3つのファイル (`requirements.md`, `design.md`, `tasklist.md`) の内容を生成する。

## ステップ5: 品質レビューと自動修正

### 5.1 レビュー観点

| 観点 | チェック内容 |
|------|-------------|
| 完全性 | 必須セクションが埋まっているか |
| 実装可能性 | 曖昧表現がないか |
| 測定可能性 | 受け入れ条件が定量的・検証可能か |
| トレーサビリティ | 機能→条件→テストが紐づいているか |

### 5.2 曖昧表現の検出パターン

以下の表現を検出対象とする:
```
NG: "適宜", "必要に応じて", "適切に", "高速に", "十分な", "可能な限り", "など", "等"
OK: "100件を3秒以内", "エラー率1%以下", "ステータス200を返す", "ログに出力する"
```

### 5.3 自動修正ルール

| 問題種別 | 修正方法 |
|----------|----------|
| 曖昧表現 | 具体的な数値・条件に置換（文脈から推測） |
| 非測定可能な条件 | 検証可能な形式に書き換え |
| 欠落セクション | テンプレートから必須項目を補完 |
| トレーサビリティ欠如 | 機能→条件→テストの紐づけを追加 |

### 5.4 修正の実行

1. requirements.mdとdesign.mdを読み込み
2. 各レビュー観点でチェックを実行
3. 検出した問題を自動修正
4. 修正後のファイルを保存

### 5.5 修正箇所の出力形式（diff風）

修正箇所を以下の形式で出力する:

```diff
## 受け入れ条件

### AC-1: 記事取得
- - 過去1週間の記事を適切に取得できる
+ - 過去7日間の記事を全件取得し、取得件数をログに出力する
+ - 記事が0件の場合はエラーではなく空リストを返す

### AC-2: 重要度判定
- - AIが高速に重要度を判定する
+ - 1記事あたり5秒以内に重要度スコア(0-100)を算出する
+ - スコア上位20件を選出する
```

## ステップ6: レビューレポート出力

以下の構成でレビューレポートを出力する:

### レビューレポート構成

```markdown
# 計画品質レビューレポート

## 1. 検出された問題の一覧

| # | ファイル | セクション | 問題種別 | 内容 |
|---|----------|-----------|----------|------|
| 1 | requirements.md | AC-1 | 曖昧表現 | "適切に" |
| 2 | design.md | エラー処理 | 欠落 | リトライ戦略未定義 |

## 2. 自動修正された箇所

[diff形式で修正箇所を表示]

## 3. 手動確認が必要な項目

[自動修正できなかった問題のリスト]

## 4. 最終品質スコア

| 観点 | スコア | 判定 |
|------|--------|------|
| 完全性 | 90% | PASS |
| 実装可能性 | 85% | PASS |
| 測定可能性 | 80% | PASS |
| トレーサビリティ | 75% | WARN |
| **総合** | **82.5%** | **PASS** |

※ 70%未満の観点がある場合は手動修正を推奨
```

## ステップ7: ユーザー確認で停止

**このステップでワークフローは停止する。**

以下の情報をユーザーに提示し、確認を待つ:

1. 作成されたファイルの一覧
   - `.steering/[日付]-[機能名]/requirements.md`
   - `.steering/[日付]-[機能名]/design.md`
   - `.steering/[日付]-[機能名]/tasklist.md`

2. レビューレポート（ステップ6の内容）

3. 次のアクション案内
   ```
   計画ドキュメントの作成が完了しました。

   次のステップ:
   1. 上記ファイルを確認し、必要に応じて修正してください
   2. 問題がなければ `/implement-feature [機能名]` で実装を開始できます

   ※ 計画に問題がある場合は、ファイルを直接編集するか、
      `/plan-feature [機能名]` を再実行してください
   ```

---

## 完了条件

このワークフローは、以下の条件を満たした時点で完了（ユーザー確認待ち）となる:

- ステアリングディレクトリが作成されている
- requirements.md, design.md, tasklist.md が生成されている
- 品質レビューが実行され、可能な範囲で自動修正が適用されている
- レビューレポートがユーザーに提示されている
