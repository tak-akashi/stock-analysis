# 全ドキュメント一括生成

このプロジェクトの全ドキュメントを一括生成してください。
新規プロジェクトと既存プロジェクトの両方に対応しています。

---

## ステップ0: プロジェクト状態の検出

まず、プロジェクトの状態を判定してください。

### 検出対象

1. **ソースコードの存在確認**
   - `src/`, `lib/`, `app/`, `backend/`, `frontend/` などの主要ディレクトリ
   - `.py`, `.ts`, `.js`, `.go`, `.rs` などのソースファイル
   - 10個以上の実質的なソースファイルがあれば「ソースコード存在」と判定

2. **アイデアファイルの存在確認**
   - `docs/ideas/*.md` をチェック
   - 1個以上あれば「アイデアファイル存在」と判定

### 判定ロジック

| ソースコード | `docs/ideas/*.md` | 判定 | source of truth |
|--------------|-------------------|------|-----------------|
| 存在 | なし | **既存プロジェクトモード** | コード |
| なし/少 | 存在 | **新規プロジェクトモード** | ideas |
| 両方存在 | 両方存在 | **ユーザーに選択させる** | - |
| どちらもなし | どちらもなし | **エラー**（/brainstormを案内） | - |

### 曖昧なケースの確認

ソースコードとアイデアファイルが両方存在する場合、AskUserQuestionで確認:

```
検出結果:
- ソースファイル: {N}個検出
- アイデアファイル: {N}個検出

どちらのモードで実行しますか？
```

選択肢:
1. **既存モード（推奨）** - コードからドキュメント逆生成
2. **新規モード** - アイデアからドキュメント生成

### エラー時の案内

どちらも存在しない場合:
```
ドキュメント生成のソースが見つかりません。

以下のいずれかを実行してください:
- /brainstorm でアイデアを作成（新規プロジェクトの場合）
- ソースコードを追加（既存プロジェクトの場合）
```

---

## 既存プロジェクトモード

ソースコードをsource of truthとしてドキュメントを逆生成します。

### 手順

1. **プロジェクト構造の分析**
   - ソースコードのディレクトリ構造を把握
   - 主要なモジュール・パッケージを特定
   - 使用言語・フレームワークを検出

2. **既存ドキュメントの参照**（存在する場合）

   `docs/` 配下の確認対象:
   - `docs/*.md`（ルート直下のドキュメント）
   - `docs/core/*.md`（以前生成されたドキュメント）
   - `README.md`, `CLAUDE.md`

   **活用方針**:
   | 状況 | 対応 |
   |------|------|
   | コードと整合 | 記述を参考に、表現や構成を引き継ぐ |
   | コードと不整合 | **コードを優先**、古い記述は無視 |
   | 関連性が不明 | コードベースのみから生成 |

   **注意**: 既存ドキュメントはあくまで参考。source of truthはコードベース

3. **ドキュメント生成**（`docs/core/` に出力）

   各ドキュメントはSkillのテンプレート構造を参照し、コードから内容を逆生成:

   **コアドキュメント（必須）:**

   | ドキュメント | 参照Skill | 内容 |
   |-------------|-----------|------|
   | `architecture.md` | `Skill('architecture-design')` | 実コードから逆生成 |
   | `functional-design.md` | `Skill('functional-design')` | 実装機能の設計書 |
   | `repository-structure.md` | `Skill('repository-structure')` | 実ディレクトリ構造 |
   | `development-guidelines.md` | `Skill('development-guidelines')` | 既存パターンから規約抽出 |
   | `glossary.md` | `Skill('glossary-creation')` | プロジェクト用語集 |

   **オプションドキュメント（必要に応じて）:**

   | ドキュメント | 参照Skill | 内容 |
   |-------------|-----------|------|
   | `api-reference.md` | - | 実在クラス/関数を文書化 |
   | `diagrams.md` | - | 実データフローを図示 |
   | `CHANGELOG.md` | - | gitログから生成 |

4. **生成後の確認**
   - 各ファイルの存在確認
   - 生成サマリーを表示

---

## 新規プロジェクトモード

`docs/ideas/*.md` をsource of truthとして計画段階ドキュメントを生成します。

### 手順

1. **アイデアファイルの選択**

   複数のideaファイルがある場合、AskUserQuestionで選択:
   ```
   docs/ideas/ に複数のアイデアファイルが見つかりました:
   1. 20250115-auth-feature.md
   2. 20250120-api-design.md
   3. 20250124-data-pipeline.md

   どのアイデアからドキュメントを生成しますか？
   ```

   1つだけの場合はそのまま使用。

2. **不足情報の一括確認**

   アイデアファイルの「技術的考慮事項」に記載がない場合、AskUserQuestionで一括確認:
   ```
   ドキュメント生成に必要な情報を確認します:
   ```

   確認項目（該当するもののみ）:
   - 主要言語: [Python / TypeScript / Go / その他]
   - Webフレームワーク: [FastAPI / Express / Gin / なし]
   - データベース: [SQLite / PostgreSQL / なし]
   - テストフレームワーク: [pytest / jest / go test]

3. **計画段階ドキュメント生成**（`docs/core/` に出力）

   各ドキュメントは対応するSkillのテンプレート・ガイドを参照して生成:

   **コアドキュメント（必須）:**

   | ドキュメント | 参照Skill | 内容 |
   |-------------|-----------|------|
   | `product-requirements.md` | `Skill('prd-writing')` | 詳細なプロダクト要求定義書 |
   | `functional-design.md` | `Skill('functional-design')` | 機能設計書 |
   | `architecture.md` | `Skill('architecture-design')` | 想定アーキテクチャ構造 |
   | `repository-structure.md` | `Skill('repository-structure')` | 想定ディレクトリ構造 |
   | `development-guidelines.md` | `Skill('development-guidelines')` | 技術スタックに基づく規約 |
   | `glossary.md` | `Skill('glossary-creation')` | プロジェクト用語集 |

   **オプションドキュメント（必要に応じて）:**

   | ドキュメント | 参照Skill | 内容 |
   |-------------|-----------|------|
   | `api-reference.md` | - | 想定APIのスタブ |
   | `diagrams.md` | - | 想定フローのMermaid図 |
   | `CHANGELOG.md` | - | 初期計画として生成 |

   **生成順序:**
   1. `product-requirements.md`（最初に生成、他の基盤となる）
   2. `functional-design.md`
   3. `architecture.md`
   4. `repository-structure.md`
   5. `development-guidelines.md`
   6. `glossary.md`
   7. `api-reference.md`, `diagrams.md`, `CHANGELOG.md`（オプション）

4. **計画段階マーカーの付与**

   全ドキュメントの冒頭に以下を追加:
   ```markdown
   > **ステータス: 計画段階**
   > このドキュメントは `docs/ideas/{filename}.md` から生成されました。
   > 実装後は `/update-docs` で実態に同期してください。
   ```

5. **生成後の確認**
   - 各ファイルの存在確認
   - 生成サマリーを表示

---

## 出力先

```
docs/core/
├── product-requirements.md     # 詳細なPRD（新規モードのみ）
├── functional-design.md        # 機能設計書
├── architecture.md             # アーキテクチャ設計書
├── repository-structure.md     # リポジトリ構造定義書
├── development-guidelines.md   # 開発ガイドライン
├── glossary.md                 # 用語集
├── api-reference.md            # API仕様書（オプション）
├── diagrams.md                 # 図表（オプション）
└── CHANGELOG.md                # 変更履歴（オプション）
```

---

## 生成ドキュメントの違い（モード別）

### コアドキュメント

| ドキュメント | 既存プロジェクト | 新規プロジェクト |
|-------------|------------------|------------------|
| `product-requirements.md` | 生成しない（実装済み） | **詳細なPRD**を生成 |
| `functional-design.md` | 実装機能から逆生成 | アイデアから**想定**設計を生成 |
| `architecture.md` | 実コードから逆生成 | アイデアから**想定**構造を生成 |
| `repository-structure.md` | 実ディレクトリ構造 | **想定**ディレクトリ構造 |
| `development-guidelines.md` | 既存パターンから規約抽出 | 技術スタックに基づく規約 |
| `glossary.md` | コードから用語抽出 | アイデアから用語定義 |

### オプションドキュメント

| ドキュメント | 既存プロジェクト | 新規プロジェクト |
|-------------|------------------|------------------|
| `api-reference.md` | 実在クラス/関数を文書化 | **想定API**のスタブ生成 |
| `diagrams.md` | 実データフローを図示 | **想定**フローを図示 |
| `CHANGELOG.md` | gitログから生成 | 「初期計画」として生成 |

---

## source of truth の原則

| プロジェクト状態 | source of truth | 更新方向 |
|------------------|-----------------|----------|
| 新規（計画段階） | `docs/ideas/*.md` | ideas → core |
| 既存（実装済み） | ソースコード | code → core |
| 実装完了後 | ソースコード | `/update-docs`で同期 |

**原則**: `docs/core/`は常に派生物（sourceではない）

---

## 注意事項

- 既存ファイルは上書きされます
- プロジェクトの実態（コードまたはアイデア）に基づいて内容を生成してください
- 不明な部分は推測せず、「要確認」と記載してください
- 新規プロジェクトモードでは、計画段階マーカーを必ず付与してください

---

## product-requirements.md の生成仕様

新規プロジェクトモードで生成する `product-requirements.md` は、以下の構成で作成してください。

### 必須セクション

1. **プロダクト概要**
   - 名称
   - プロダクトコンセプト（箇条書き4項目程度）
   - プロダクトビジョン（1段落）
   - 目的（箇条書き）

2. **ターゲットユーザー**
   - プライマリーペルソナ（名前、年齢、属性）
   - 基本属性
   - 技術スタック（ユーザーの技術レベル）
   - 現在の課題
   - 期待する解決策
   - 1日の典型的なワークフロー

3. **成功指標（KPIs）**
   - プライマリーKPI（表形式: 指標 / 目標 / 測定方法）
   - セカンダリーKPI（表形式）

4. **機能要件**（優先度別）
   - P0（必須）: コア機能
   - P1（重要）: 重要機能
   - P2（できれば）: 将来機能

   各機能には以下を含める:
   - **ユーザーストーリー**: 「〜として、〜するために、〜が欲しい」形式
   - **受け入れ条件**: チェックリスト形式（`- [ ]`）
   - **検証方法**: 表形式（検証項目 / テストデータ / 合格基準）
   - **優先度**: P0/P1/P2

5. **非機能要件**
   - パフォーマンス（表形式: 処理 / 目標 / 測定条件）
   - ユーザビリティ
   - 信頼性
   - セキュリティ

6. **技術スタック**
   - 表形式（項目 / 技術 / 選定理由）

7. **スコープ外**
   - 明示的に対象外とする項目（箇条書き）

8. **リスクと対策**
   - 表形式（リスク / 影響度 / 発生可能性 / 対策）

9. **開発フェーズ**
   - フェーズごとに:
     - 目標
     - 実装内容
     - 成功基準（チェックリスト形式）

10. **APIインターフェース（想定）**
    - Pythonコード例
    - REST API例（エンドポイント一覧）

### 参照ドキュメント

既存の詳細なPRD例として `docs/refs/product-requirements.md` を参照可能。
形式や粒度の参考にしてください。
